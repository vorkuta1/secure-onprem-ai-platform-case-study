flowchart LR
  %% Users
  U1[Analysts / Non-technical users]
  U2[Data Scientists]

  %% Platform Ops
  subgraph Ops[Platform Ops]
    GL[GitLab CI]
    REG[GitLab Container Registry]
    PRT[Portainer (DEV)]
    AGT[Portainer Agent (PROD)]
  end

  %% Environments
  subgraph DEV[DEV / STAGING VM]
    DEVUI[Echo UI (DEV)]
    DEVAPI[Echo Backend/API (DEV)]
    DEVQ[Asynq Queue (Redis)]
    DEVW[Workers (ASR / Diar / OCR / MT / Summ)]
    DEVLLM[LLM API (Ollama)]
    DEVTR[Translation API]
    DEVOCR[OCR API]
    DEVVDB[Vector DB (Embeddings / RAG)]
    DEVMG[MongoDB (Auth + app data)]
    DEVST[(NFS/SMB + MinIO)\nShort-lived artifacts]
    DEVOBS[Prometheus + Grafana + Loki]
    DEVQMON[AsynqMon]
    DEVJH[JupyterHub]
  end

  subgraph PROD[PROD VM]
    PRUI[Echo UI (PROD)]
    PRAPI[Echo Backend/API (PROD)]
    PRQ[Asynq Queue (Redis)]
    PRW[Workers (ASR / Diar / OCR / MT / Summ)]
    PRLLM[LLM API (Ollama)]
    PRTR[Translation API]
    PROCRO[OCR API]
    PRVDB[Vector DB (Embeddings / RAG)]
    PRMG[MongoDB (Auth + app data)]
    PRST[(NFS/SMB + MinIO)\nShort-lived artifacts]
    PROBS[Prometheus + Grafana + Loki]
    PRQMON[AsynqMon]
    PRJH[JupyterHub]
  end

  %% Compute
  H100[(Single H100 GPU\nShared across two VMs)]

  %% Identity
  IDP[Keycloak (optional)\nAD integration]
  LA[Local Auth (fallback)]

  %% Flows - Users
  U1 -->|Web| PRUI
  PRUI --> PRAPI
  PRAPI --> PRQ
  PRQ --> PRW
  PRW --> PRLLM
  PRW --> PRTR
  PRW --> PROCRO
  PRAPI --> PRVDB
  PRAPI --> PRMG
  PRAPI --> PRST

  U2 -->|Notebooks| PRJH
  PRJH -->|GPU jobs| H100
  PRW -->|GPU inference| H100
  PRJH --> PRST
  PRJH --> PRVDB

  %% Observability
  PRAPI --> PROBS
  PRW --> PROBS
  PRQ --> PRQMON
  PRQMON --> PROBS

  %% Ops / Deploy
  GL --> REG
  REG --> PRT
  REG --> AGT
  PRT --> DEVUI
  PRT --> DEVAPI
  AGT --> PRUI
  AGT --> PRAPI

  %% Auth
  PRUI -->|Auth| LA
  PRUI -->|SSO| IDP
  PRAPI --> PRMG

